{% extends './rec_base.html' %} {% load static %} {%load django_tables2%} {%load
render_table from django_tables2 %} {% block title %} Item Details {% endblock%}
{% block body %}
<div style="position: absolute; top: 4vh; left: 18%; width: 80%; height: 90%; ">
  <h1 style="text-align: center; margin-bottom: 20px">{{department_data.name}}</h1>
  <div class="row" style="display: flex; flex-direction: column; height: inherit; justify-content: space-evenly;">
    <div class="col-8 card" style="
          box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px,
            rgba(0, 0, 0, 0.23) 0px 3px 6px;
          width: 100%;
          height: 50%;
        ">
      <div class="card-body">
        <h2 style="margin-bottom: 20px; text-align: center">
          <i class="fa fa-solid fa-user" style="margin-right: 5px"></i>
          department Members
        </h2>
        <div style = "height: 225px; overflow-y: auto;">
          {% render_table table %}
        </div>
        <div id = "new_pagination" style = "margin-top: 10px;"></div>
      </div>
    </div>
    <div style="display:flex; justify-content: space-evenly;">
    <div class="col-4" style="width: 40%; padding: 0;">
      <div class="card" style="
            padding: 15px;
            box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px,
              rgba(0, 0, 0, 0.23) 0px 3px 6px;

          ">
          <h2 style="text-align: center">Return Items</h2>
        <div style = "max-height: 125px; overflow-y: auto;">
            <table id="departmented_table" class="table table-dark">
              <thead>
                <tr>
                  <th scope="col">Item Code</th>
                  <th scope="col">Item Name</th>
                  <th scope="col">Issued  Quantity</Th>
                  <th scope="col">To Return</th>
                </tr>
              </thead>
              <tbody>
                {% for instance in issueditemquant %}
                <tr>
                  <td>{{ instance.item.item_code}}</td>
                  <td>{{ instance.item.name}}</td>
                  <td>{{ instance.quantity }}</td>
                  <td><input type="checkbox" value = "{{instance.item.static_id}}" class = "issued_items_checkboxes"></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            </div>
            <input type="number" id="return_quantity" class = "form-control" min="1" placeholder="Enter quantity to return per selected item">
            <br>
            <button id="issued_item_btn" class="btn btn-success" style="width: fit-content; margin: auto;">Return Item</button>
          </form>
      </div>
    </div>
    <div class="card" style="
            box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px,
              rgba(0, 0, 0, 0.23) 0px 3px 6px;
            width: 40%;
          ">
      <div style="margin-bottom: 4%">
        <h2 style="text-align: center">
          Issue Items
        </h2>
      </div>

      <div>
        <form action="" style="padding: 0em 2em; display: flex; flex-direction: column; align-items: center;">
          <select class="form-select" id="item_static_id">
            {% for item in items %}
            <option value="{{item.static_id}}">
              <p>{{item.item_code}}&nbsp;&nbsp;&nbsp;{{item.name}} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
              Available Quantity :
              {{item.present_quantity}}
            </option>
            {%endfor%}
          </select>
          <br>
          <input type="number" id="item_quantity" class = "form-control" min="1"  placeholder="Enter quantity to issue for selected item">
          <br>
          <button id="issue_item_btn"  class="btn btn-success" style="position: justify;">Issue Item</button>
        </form>
      </div>
    </div>
  </div>
  </div>
</div>
</div>

<script>
  document
    .getElementById("new_pagination")
    .appendChild(document.getElementById("prev_pagination"));
  leader_id = "{{department_leader.static_id}}"
  document.getElementById(`${leader_id}_in_table`).getElementsByTagName("td")[0].innerHTML = '<i class = "fa fa-crown fa-solid" style = "color:#FFD700; margin-right : 5px"></i>' +document.getElementById(`${leader_id}_in_table`).getElementsByTagName("td")[0].innerHTML;
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript">
  // window.CSRF_TOKEN = "{{csrf_token}}";
  var item_id = null;
  function get_id(event) {
    event.preventDefault();
    var item_id = document.getElementById("item_static_id").value;
    var quantity = document.getElementById("item_quantity").value;
    var department_id = "{{department_data.static_id}}";
    if(quantity<=0){
    swal({
      title: "Invalid quantity",
      text: "Quantity should be greater than 0",
      icon: "warning",
    });
    return;
  }
    $.ajax({
      type: "POST",
      datatype: "multipart/json",
      traditional: true,
      url: "{% url 'issue-item'%}",
      data: {
        item_id: item_id,
        quantity: quantity,
        department_id: department_id,
        csrfmiddlewaretoken: "{{csrf_token}}",
      },
      success: function (json) {
        swal({
          title: "Success",
          text: json.message,
          icon: "success",
        }).then(function(isConfirm){
            window.location.reload();
          });;

      },

      error: function (xhr, errmsg, err) {
        var jsondata=JSON.parse(xhr.responseText);
        swal({
          title: "Failed",
          text: jsondata.message,
          icon: "error",
        });
      },
    });
  }
  var submit_button = document.getElementById("issue_item_btn");
  submit_button.addEventListener("click", get_id);

  // returning
  function get_id2(event){
    event.preventDefault();
    //get data from the input (num items to be returned) and push in the ajax
    var department_id = "{{department_data.static_id}}";
    var itemlist= [];
    issued_item_checkboxes = document.getElementsByClassName("issued_items_checkboxes");
    for(var i=0;i<issued_item_checkboxes.length;i++){
      if(issued_item_checkboxes[i].checked){
       itemlist.push(issued_item_checkboxes[i].value);
      }
    }
    var return_quantity = document.getElementById("return_quantity").value

    $.ajax({
      type: "POST",
      datatype: "multipart/json",
      traditional: true,
      url: "{% url 'return-item'%}",
      data: {
        itemlist: itemlist,
        return_quantity: return_quantity,
        department_id: department_id,
        csrfmiddlewaretoken: "{{csrf_token}}",
      },
      success: function (json) {
        swal({
          title: "Success",
          text: json.message,
          icon: "success",
        }).then(function(isConfirm){
          window.location.reload();;})

      },

      error: function (xhr, errmsg, err) {
        var jsondata=JSON.parse(xhr.responseText);
        swal({
          title: "Items Could Not be Returned",
          text: jsondata.message,
          icon: "warning",
        });
      },
    });
  }
  var submit_button = document.getElementById("issued_item_btn");
  submit_button.addEventListener("click", get_id2);
</script>


{% endblock %}
